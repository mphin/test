name: Update List
on:
  push:
    branches:
      - main
    paths:
      - 'rules/*.list'
jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Set up time zone
        run: sudo timedatectl set-timezone Asia/Shanghai
      
      - name: Check out code
        uses: actions/checkout@v2

      - name: Get last commit files
        id: last_commit
        run: |
          echo "::set-output name=sha::$(git rev-parse HEAD)"

      - name: Get changed files
        id: file_list
        run: |
          COMMIT=${{ steps.last_commit.outputs.sha }}
          URL="https://api.github.com/repos/${{ github.repository }}/compare/${COMMIT}^...${COMMIT}"
          FILES=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" $URL | jq -r '.files[] | select(.filename | test("^rules/.*\\.list$")) | .filename')
          echo "$FILES" > changed_files.txt

      - name: Update List
        run: |
          # 获取当前时间
          current_date=$(TZ=Asia/Shanghai date '+%Y年%m月%d日%H:%M:%S')

          # 统计非空行和非注释行的数量
          count=$(grep -v -e '^$' -e '^#' $(cat changed_files.txt) | wc -l)

          # 更新文件内容
          for file in $(cat changed_files.txt); do
            sed -i "s/^# 更新：.*/# 更新：$current_date/" $file
            sed -i "s/^# 数量：.*/# 数量：$count/" $file
          done

      - name: Commit and push changes
        run: |
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add -A
          git commit -m "Update list files [skip ci]"
          git push